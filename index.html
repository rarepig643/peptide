<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>í©íƒ€ì´ë“œ ë§¤ë‹ˆì € (ê³µìš©)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
  /* ë””ìì¸ ìŠ¤íƒ€ì¼ */
  * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
  body { background: #f4f7f6; margin: 0; padding: 20px; color: #333; padding-bottom: 80px; }
  .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
  h2, h3 { text-align: center; margin-top: 0; color: #333; }
  input, select, button { width: 100%; height: 45px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; text-align: center; }
  button { background: #333; color: white; font-weight: bold; border: none; cursor: pointer; }
  .row { display: flex; gap: 5px; }
  .card { padding: 15px; border-radius: 10px; color: white; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  .bg-blue { background: #36a2eb; } .bg-red { background: #ff6384; } .bg-green { background: #28a745; } .bg-purple { background: #6610f2; }
  .login-box { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
  .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; display: flex; border-top: 1px solid #eee; z-index: 100; }
  .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12px; color: #aaa; }
  .nav-item.active { color: #333; font-weight: bold; }
  .page { display: none; } .page.active { display: block; }
  .list-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
  .del-btn { width: auto; height: auto; padding: 5px 10px; background: #dc3545; font-size: 12px; margin: 0; }
</style>
</head>
<body>

<div id="login-page" class="login-box">
  <h1>ğŸ’‰ í©íƒ€ì´ë“œ ë§¤ë‹ˆì €</h1>
  <p>ë¡œê·¸ì¸í•˜ë©´ ê¸°ë¡ì´ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
  <button onclick="googleLogin()" style="background:white; color:black; border:1px solid #ddd;">ğŸ”µ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
</div>

<div id="app-page" style="display:none;">
  <div style="text-align:right; margin-bottom:10px;">
    <span id="user-name" style="font-size:12px; color:#666;"></span>
    <button onclick="logout()" style="width:auto; height:30px; font-size:12px; background:#999; margin-left:5px;">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div id="p-manager" class="page active">
    <div class="container">
      <h3>íˆ¬ì•½ ê¸°ë¡</h3>
      <div class="row">
        <select id="drugType">
          <option value="tirz">í„°ì œíŒŒíƒ€ì´ë“œ (5ì¼)</option>
          <option value="reta">ë ˆíƒ€íŠ¸ë£¨íƒ€ì´ë“œ (6ì¼)</option>
          <option value="sema">ì„¸ë§ˆê¸€ë£¨íƒ€ì´ë“œ (7ì¼)</option>
        </select>
        <input type="number" id="doseAmt" placeholder="mg" step="0.1">
      </div>
      <div class="row">
        <input type="date" id="inputDate">
        <input type="time" id="inputTime">
      </div>
      <button onclick="addDose()" class="bg-green">+ ê¸°ë¡ ì¶”ê°€</button>
      
      <div style="margin-top:20px;">
        <div class="card bg-blue"><span>í„°ì œ ë†ë„</span><span id="valTirz">0.00</span></div>
        <div class="card bg-red"><span>ë ˆíƒ€ ë†ë„</span><span id="valReta">0.00</span></div>
        <div class="card bg-green"><span>ì„¸ë§ˆ ë†ë„</span><span id="valSema">0.00</span></div>
      </div>
      <div style="height:250px;"><canvas id="myChart"></canvas></div>
      <div id="doseList" style="margin-top:20px;"></div>
    </div>
  </div>

  <div id="p-weight" class="page">
    <div class="container">
      <h3>ì²´ì¤‘ ê¸°ë¡</h3>
      <div class="row">
        <input type="number" id="weightInput" placeholder="kg" step="0.1">
        <button onclick="addWeight()" class="bg-purple">ê¸°ë¡</button>
      </div>
      <div class="card bg-purple"><span>í˜„ì¬ ì²´ì¤‘</span><span id="curWeight">-- kg</span></div>
      <div style="height:250px;"><canvas id="weightChart"></canvas></div>
      <div id="weightList" style="margin-top:20px;"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="goPage('manager', this)">ğŸ’‰ íˆ¬ì•½</div>
    <div class="nav-item" onclick="goPage('weight', this)">âš–ï¸ ì²´ì¤‘</div>
  </div>
</div>

<script type="module">
  // ============================================================
  // [ì¤‘ìš”] ì•„ê¹Œ ë³µì‚¬í•œ í‚¤ ê°’ì„ ì•„ë˜ const firebaseConfig ì•ˆì— ë®ì–´ì”Œìš°ì„¸ìš”!
  // ============================================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDcrkHfImrYEZfy5Q0awsqCwL8BxkeHzF0",
    authDomain: "peptide-manager.firebaseapp.com",
    projectId: "peptide-manager",
    storageBucket: "peptide-manager.firebasestorage.app",
    messagingSenderId: "571787275208",
    appId: "1:571787275208:web:66d40af3559d6d859d2efd",
    measurementId: "G-HR40KWW12W"
  };

  // íŒŒì´ì–´ë² ì´ìŠ¤ ì‹œì‘
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let currentUser = null;
  let doseChart = null, weightChartObj = null;

  // 1. ë¡œê·¸ì¸ ê´€ë¦¬
  window.googleLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('app-page').style.display = 'block';
      document.getElementById('user-name').innerText = user.email;
      initApp();
    } else {
      currentUser = null;
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('app-page').style.display = 'none';
    }
  });

  // 2. ë°ì´í„° ê´€ë¦¬ (ìë™ ì‹¤ì‹œê°„ ì—°ë™)
  function initApp() {
    // ë‚ ì§œ ê¸°ë³¸ê°’
    document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('inputTime').value = new Date().toTimeString().slice(0,5);

    // íˆ¬ì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ë‚´ ë°ì´í„°ë§Œ)
    const qDose = query(collection(db, "doses"), where("uid", "==", currentUser.uid), orderBy("time", "asc"));
    onSnapshot(qDose, (snap) => {
      const doses = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderDoses(doses);
      updateChart(doses);
      updateLevels(doses);
    });

    // ì²´ì¤‘ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ë‚´ ë°ì´í„°ë§Œ)
    const qWeight = query(collection(db, "weights"), where("uid", "==", currentUser.uid), orderBy("time", "asc"));
    onSnapshot(qWeight, (snap) => {
      const weights = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderWeights(weights);
      updateWeightChart(weights);
    });
  }

  // 3. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
  window.addDose = () => {
    const amt = parseFloat(document.getElementById('doseAmt').value);
    if(!amt) return alert("ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
    const ts = new Date(document.getElementById('inputDate').value + 'T' + document.getElementById('inputTime').value).getTime();
    addDoc(collection(db, "doses"), {
      uid: currentUser.uid, // â˜…í•µì‹¬: ë‚´ ì•„ì´ë””í‘œ ë¶™ì´ê¸°
      type: document.getElementById('drugType').value,
      amt: amt,
      time: ts
    });
    alert("ì €ì¥ë¨");
  };

  window.addWeight = () => {
    const w = parseFloat(document.getElementById('weightInput').value);
    if(!w) return;
    addDoc(collection(db, "weights"), {
      uid: currentUser.uid, // â˜…í•µì‹¬: ë‚´ ì•„ì´ë””í‘œ ë¶™ì´ê¸°
      weight: w,
      time: Date.now()
    });
    document.getElementById('weightInput').value = '';
  };

  window.delItem = (col, id) => {
    if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) deleteDoc(doc(db, col, id));
  };

  // 4. í™”ë©´ ê·¸ë¦¬ê¸°
  function renderDoses(list) {
    const el = document.getElementById('doseList'); el.innerHTML = '';
    list.slice().reverse().forEach(d => {
      const date = new Date(d.time);
      el.innerHTML += `<div class="list-item"><span>${date.getMonth()+1}/${date.getDate()} <b>${d.type} ${d.amt}mg</b></span> <button class="del-btn" onclick="delItem('doses', '${d.id}')">ì‚­ì œ</button></div>`;
    });
  }

  function renderWeights(list) {
    const el = document.getElementById('weightList'); el.innerHTML = '';
    if(list.length) document.getElementById('curWeight').innerText = list[list.length-1].weight + " kg";
    list.slice().reverse().forEach(d => {
      const date = new Date(d.time);
      el.innerHTML += `<div class="list-item"><span>${date.getMonth()+1}/${date.getDate()} <b>${d.weight}kg</b></span> <button class="del-btn" onclick="delItem('weights', '${d.id}')">ì‚­ì œ</button></div>`;
    });
  }

  // ê°„ë‹¨í•œ ë°˜ê°ê¸° ê³„ì‚° ë° ì°¨íŠ¸
  function updateLevels(doses) {
    const now = Date.now();
    const configs = { tirz: [5, 1], reta: [6, 1.5], sema: [7, 2] }; // ë°˜ê°ê¸° ì„¤ì •
    ['tirz', 'reta', 'sema'].forEach(type => {
      let total = 0;
      doses.filter(d => d.type === type).forEach(d => {
        const days = (now - d.time) / 86400000;
        if(days >= 0) total += d.amt * Math.pow(0.5, days/configs[type][0]);
      });
      document.getElementById('val'+type.charAt(0).toUpperCase()+type.slice(1)).innerText = total.toFixed(2);
    });
  }

  function updateChart(doses) {
    const ctx = document.getElementById('myChart');
    if(doseChart) doseChart.destroy();
    // ê°„ë‹¨ ì°¨íŠ¸ (ìµœê·¼ 30ì¼)
    const labels = [], d1 = [], d2 = [], d3 = [];
    for(let i=0; i<30; i++) {
        const t = Date.now() + (i-5)*86400000;
        labels.push(new Date(t).getDate());
        d1.push(calcSim(doses, t, 'tirz')); d2.push(calcSim(doses, t, 'reta')); d3.push(calcSim(doses, t, 'sema'));
    }
    doseChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [
      {label:'T', data:d1, borderColor:'#36a2eb', pointRadius:0},
      {label:'R', data:d2, borderColor:'#ff6384', pointRadius:0},
      {label:'S', data:d3, borderColor:'#28a745', pointRadius:0}
    ]}, options: { responsive:true, maintainAspectRatio:false } });
  }

  function updateWeightChart(weights) {
    const ctx = document.getElementById('weightChart');
    if(weightChartObj) weightChartObj.destroy();
    weightChartObj = new Chart(ctx, { type: 'line', data: {
      labels: weights.map(w => new Date(w.time).getDate()),
      datasets: [{ label: 'ì²´ì¤‘', data: weights.map(w => w.weight), borderColor: '#6610f2' }]
    }, options: { responsive:true, maintainAspectRatio:false } });
  }

  function calcSim(doses, time, type) {
    let sum = 0; const h = type==='tirz'?5:(type==='reta'?6:7);
    doses.filter(d=>d.type===type && d.time <= time).forEach(d => sum += d.amt * Math.pow(0.5, (time-d.time)/86400000/h));
    return sum;
  }

  window.goPage = (p, el) => {
    document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
    document.getElementById(p==='manager'?'p-manager':'p-weight').classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
  };
</script>
</body>
</html>