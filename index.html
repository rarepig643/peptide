<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>í©íƒ€ì´ë“œ ë§¤ë‹ˆì € (DBì—°ë™ ìµœì¢…)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
  /* ================= [ìŠ¤íƒ€ì¼] ================= */
  * { -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; box-sizing: border-box; }
  body { padding: 20px; background: #f4f7f6; max-width: 800px; margin: 0 auto; padding-bottom: 100px; color:#333; }
  
  /* ì…ë ¥ì°½ ë° ë²„íŠ¼ ê³µí†µ */
  input, select, button { -webkit-appearance: none; appearance: none; border-radius: 8px; border: 1px solid #ddd; height: 46px; font-size: 16px; text-align: center; background: white; }
  input:focus, select:focus { outline: none; border-color: #333; }
  button { cursor: pointer; color: white; border: none; font-weight: bold; }
  
  .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;}
  h2 { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
  
  .input-group { display: flex; gap: 8px; margin-bottom: 10px; width: 100%; }
  .btn-add { background: #28a745; width: 100%; margin-bottom: 20px; font-size: 1.1rem; }
  
  /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ì˜¤ë¥˜ í•´ê²°) */
  input[type="checkbox"] { width: 20px; height: 20px; vertical-align: middle; accent-color: #dc3545; cursor: pointer; margin-right: 8px; -webkit-appearance: checkbox; display: inline-block; }
  label { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; }

  /* ìƒíƒœ ì¹´ë“œ */
  .status-board { display: flex; flex-direction: column; gap: 10px; margin: 10px 0 20px; }
  .status-card { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-radius: 12px; color: white; }
  .card-tirz { background: linear-gradient(90deg, #36a2eb, #0056b3); } 
  .card-reta { background: linear-gradient(90deg, #ff6384, #c82333); } 
  .card-sema { background: linear-gradient(90deg, #28a745, #1e7e34); } 
  .card-weight { background: linear-gradient(90deg, #6610f2, #490bc4); }
  .current-val { font-size: 1.4rem; font-weight: bold; }
  .edit-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); font-size: 0.8rem; padding: 5px 10px; height: auto; border-radius: 15px; }

  /* íƒ­ ë²„íŠ¼ */
  .tab-container { display: flex; gap: 5px; margin-bottom: 15px; }
  .tab-btn { flex: 1; background: #f8f9fa; color: #555; height: 36px; border-radius: 20px; font-size: 0.9rem; }
  .tab-btn.active { background: #333; color: white; }
  
  /* ì°¨íŠ¸ */
  .chart-box { height: 280px; margin-bottom: 20px; }
  
  /* í…Œì´ë¸” */
  .daily-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; text-align: center; }
  .daily-table th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #eee; }
  .daily-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
  .today-row { background-color: #fff9c4; font-weight: bold; }
  
  /* ë¦¬ìŠ¤íŠ¸ */
  .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; }
  .tag { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; margin-right: 8px; font-weight: bold; }
  .tag.tirz { background: #36a2eb; } .tag.reta { background: #ff6384; } .tag.sema { background: #28a745; } .tag.weight { background: #6610f2; }
  .del-btn { background: none; color: #aaa; font-size: 1.2rem; padding: 5px; height: auto; width: auto; }

  /* ëª¨ë‹¬ */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999; }
  .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; }
  .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
  .btn-pop { flex: 1; border-radius: 8px; color: white; }
  .bg-gray { background: #6c757d; } .bg-blue { background: #36a2eb; } .bg-red { background: #dc3545; } .bg-purple { background: #6610f2; }

  /* í˜ì´ì§€ ì „í™˜ */
  .page-section { display: none; } .page-section.active { display: block; }
  
  /* í•˜ë‹¨ ë„¤ë¹„ */
  .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; display: flex; border-top: 1px solid #eee; z-index: 999; }
  .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #aaa; font-size: 0.8rem; }
  .nav-item.active { color: #333; font-weight: bold; }
  
  /* ë¡œê·¸ì¸ */
  #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .google-btn { background: white; color: #333; border: 1px solid #ddd; padding: 10px 20px; display: flex; align-items: center; gap: 10px; font-weight: bold; width: auto; }
</style>
</head>
<body>

<div id="login-screen">
  <h1>ğŸ’‰ í©íƒ€ì´ë“œ & ì²´ì¤‘</h1>
  <p>ë¡œê·¸ì¸í•˜ì—¬ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>
  <button id="btnLogin" class="google-btn">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
</div>

<div id="main-app" style="display:none;">
    <div style="text-align: right; margin-bottom: 10px;">
        <span id="user-email" style="font-size:0.9rem; color:#666;"></span>
        <button onclick="logout()" style="background:#666; font-size:0.8rem; padding:5px 10px; height:auto; margin-left:10px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="section-manager" class="page-section active">
        <div class="container">
            <h2>ğŸ’‰ íˆ¬ì•½ ë° ì”ì—¬ëŸ‰</h2>
            <div class="input-group">
                <select id="drugType" style="flex:1.5; font-weight:bold; color:#36a2eb;">
                    <option value="tirz">í„°ì œíŒŒíƒ€ì´ë“œ (5ì¼)</option>
                    <option value="reta">ë ˆíƒ€íŠ¸ë£¨íƒ€ì´ë“œ (6ì¼)</option>
                    <option value="sema">ì„¸ë§ˆê¸€ë£¨íƒ€ì´ë“œ (7ì¼)</option>
                </select>
                <input type="number" id="doseAmt" placeholder="mg" style="flex:1;">
            </div>
            <div class="input-group">
                <input type="date" id="inputDate">
                <input type="time" id="inputTime">
                <button onclick="setNow()" style="background:#6c757d; width:50px;">í˜„ì¬</button>
            </div>
            <button class="btn-add" onclick="add()">+ ê¸°ë¡ ì¶”ê°€</button>

            <div class="status-board">
                <div class="status-card card-tirz">
                    <div>í„°ì œíŒŒíƒ€ì´ë“œ</div>
                    <div class="current-val"><span id="valTirz">0.00</span> <span style="font-size:0.6em">mg</span></div>
                    <button class="edit-btn" onclick="openEditModal('tirz')">ìˆ˜ì •</button>
                </div>
                <div class="status-card card-reta">
                    <div>ë ˆíƒ€íŠ¸ë£¨íƒ€ì´ë“œ</div>
                    <div class="current-val"><span id="valReta">0.00</span> <span style="font-size:0.6em">mg</span></div>
                    <button class="edit-btn" onclick="openEditModal('reta')">ìˆ˜ì •</button>
                </div>
                <div class="status-card card-sema">
                    <div>ì„¸ë§ˆê¸€ë£¨íƒ€ì´ë“œ</div>
                    <div class="current-val"><span id="valSema">0.00</span> <span style="font-size:0.6em">mg</span></div>
                    <button class="edit-btn" onclick="openEditModal('sema')">ìˆ˜ì •</button>
                </div>
            </div>

            <div class="tab-container">
                <button class="tab-btn active" onclick="setViewMode('all')" id="btnAll">ì „ì²´</button>
                <button class="tab-btn" onclick="setViewMode('tirz')" id="btnTirz">í„°ì œ</button>
                <button class="tab-btn" onclick="setViewMode('reta')" id="btnReta">ë ˆíƒ€</button>
                <button class="tab-btn" onclick="setViewMode('sema')" id="btnSema">ì„¸ë§ˆ</button>
            </div>

            <div class="chart-box"><canvas id="myChart"></canvas></div>

            <h3>ğŸ“‹ íˆ¬ì•½ ë‚´ì—­</h3>
            <div id="historyList"></div>
            
            <button onclick="openResetModal()" style="width:100%; background:#6c757d; margin-top:20px;">ğŸ—‘ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="section-weight" class="page-section">
        <div class="container">
            <h2>âš–ï¸ ì²´ì¤‘ ê´€ë¦¬</h2>
            <div class="input-group">
                <input type="number" id="weightInput" placeholder="ì²´ì¤‘ (kg)" style="flex:1; font-weight:bold;">
                <button class="btn-add" style="width:80px; margin:0;" onclick="addWeight()">ê¸°ë¡</button>
            </div>
            <div class="input-group">
                <input type="date" id="weightDate">
                <input type="time" id="weightTime">
                <button onclick="setWeightNow()" style="background:#6c757d; width:50px;">í˜„ì¬</button>
            </div>

            <div class="status-board">
                <div class="status-card card-weight">
                    <div>í˜„ì¬ ì²´ì¤‘</div>
                    <div class="current-val"><span id="valCurWeight">--</span> <span style="font-size:0.6em">kg</span></div>
                </div>
            </div>

            <div class="chart-box"><canvas id="weightChart"></canvas></div>

            <h3>ğŸ“‹ ì²´ì¤‘ ê¸°ë¡</h3>
            <div id="weightList"></div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('manager', this)"><span>ğŸ“Š ì”ì—¬ëŸ‰</span></div>
        <div class="nav-item" onclick="switchPage('weight', this)"><span>âš–ï¸ ì²´ì¤‘</span></div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-box">
        <h3>í˜„ì¬ê°’ ìˆ˜ì •</h3>
        <input type="number" id="editInput" class="modal-input" placeholder="0.0" style="width:100%; margin-bottom:10px;">
        <div class="modal-btns">
            <button class="btn-pop bg-gray" onclick="closeEditModal()">ì·¨ì†Œ</button>
            <button class="btn-pop bg-blue" onclick="saveManualValue()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="resetModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:#dc3545">âš ï¸ ë°ì´í„° ì‚­ì œ</h3>
        <div style="text-align:left; padding:10px;">
            <label><input type="checkbox" id="checkTirz"> í„°ì œíŒŒíƒ€ì´ë“œ</label>
            <label><input type="checkbox" id="checkReta"> ë ˆíƒ€íŠ¸ë£¨íƒ€ì´ë“œ</label>
            <label><input type="checkbox" id="checkSema"> ì„¸ë§ˆê¸€ë£¨íƒ€ì´ë“œ</label>
        </div>
        <div class="modal-btns">
            <button class="btn-pop bg-gray" onclick="closeResetModal()">ì·¨ì†Œ</button>
            <button class="btn-pop bg-red" onclick="confirmReset()">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script type="module">
  // [1] íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (í‚¤ê°’ ë³¸ì¸ê²ƒìœ¼ë¡œ!)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // â–¼â–¼â–¼ ì—¬ê¸°ì— ë³¸ì¸ í‚¤ê°’ ë¶™ì—¬ë„£ê¸° â–¼â–¼â–¼
  const firebaseConfig = {
    apiKey: "AIzaSyDcrkHfImrYEZfy5Q0awsqCwL8BxkeHzF0",
    authDomain: "peptide-manager.firebaseapp.com",
    projectId: "peptide-manager",
    storageBucket: "peptide-manager.firebasestorage.app",
    messagingSenderId: "571787275208",
    appId: "1:571787275208:web:66d40af3559d6d859d2efd",
    measurementId: "G-HR40KWW12W"
  };
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  let currentUser = null;

  // ë³€ìˆ˜
  let doses = [], weightData = [];
  let myChart, weightChart;
  let viewMode = 'all';
  let currentEditType = '';

  const PK = { tirz: [5, 1], reta: [6, 1.5], sema: [7, 2] }; // ë°˜ê°ê¸°

  // [2] ë¡œê·¸ì¸ ì²˜ë¦¬
  document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
  window.logout = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.getElementById('user-email').innerText = user.email;
      initApp();
    } else {
      currentUser = null;
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }
  });

  function initApp() {
    setNow(); setWeightNow();
    
    // DB ë¦¬ìŠ¤ë„ˆ (íˆ¬ì•½)
    const qDose = query(collection(db, "doses"), where("uid", "==", currentUser.uid), orderBy("time", "asc"));
    onSnapshot(qDose, (snap) => {
        doses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateManager();
    });

    // DB ë¦¬ìŠ¤ë„ˆ (ì²´ì¤‘)
    const qWeight = query(collection(db, "weights"), where("uid", "==", currentUser.uid), orderBy("time", "asc"));
    onSnapshot(qWeight, (snap) => {
        weightData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        updateWeight();
    });
  }

  // [3] ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ (windowì— ë“±ë¡í•˜ì—¬ HTMLì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ í•¨)
  
  // -- ë‚ ì§œ ì„¸íŒ… --
  window.setNow = () => { document.getElementById('inputDate').value = new Date().toISOString().split('T')[0]; document.getElementById('inputTime').value = new Date().toTimeString().slice(0,5); };
  window.setWeightNow = () => { document.getElementById('weightDate').value = new Date().toISOString().split('T')[0]; document.getElementById('weightTime').value = new Date().toTimeString().slice(0,5); };

  // -- ì¶”ê°€ ë¡œì§ --
  window.add = async () => {
    if(!currentUser) return;
    const type = document.getElementById('drugType').value;
    const amt = parseFloat(document.getElementById('doseAmt').value);
    const date = document.getElementById('inputDate').value;
    const time = document.getElementById('inputTime').value;
    
    if(!amt || !date || !time) return alert("ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    try {
        await addDoc(collection(db, "doses"), {
            uid: currentUser.uid,
            type: type,
            amt: amt,
            time: new Date(`${date}T${time}`).getTime(),
            manual: false
        });
        alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
  };

  window.addWeight = async () => {
    if(!currentUser) return;
    const w = parseFloat(document.getElementById('weightInput').value);
    const date = document.getElementById('weightDate').value;
    const time = document.getElementById('weightTime').value;
    if(!w) return;

    await addDoc(collection(db, "weights"), {
        uid: currentUser.uid,
        weight: w,
        time: new Date(`${date}T${time}`).getTime()
    });
    document.getElementById('weightInput').value = '';
  };

  // -- ì‚­ì œ ë¡œì§ --
  window.delDose = async (id) => { if(confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) await deleteDoc(doc(db, "doses", id)); };
  window.delWeight = async (id) => { if(confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) await deleteDoc(doc(db, "weights", id)); };

  // -- ëª¨ë‹¬ ê´€ë ¨ --
  window.openEditModal = (t) => { currentEditType = t; document.getElementById('editModal').style.display = 'flex'; };
  window.closeEditModal = () => { document.getElementById('editModal').style.display = 'none'; };
  
  window.saveManualValue = async () => {
      if(!currentUser) return;
      const v = parseFloat(document.getElementById('editInput').value);
      if(isNaN(v)) return alert("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      
      await addDoc(collection(db, "doses"), {
          uid: currentUser.uid,
          type: currentEditType,
          amt: v,
          time: Date.now(),
          manual: true
      });
      closeEditModal();
  };

  window.openResetModal = () => document.getElementById('resetModal').style.display = 'flex';
  window.closeResetModal = () => document.getElementById('resetModal').style.display = 'none';
  
  window.confirmReset = async () => {
      const t = document.getElementById('checkTirz').checked;
      const r = document.getElementById('checkReta').checked;
      const s = document.getElementById('checkSema').checked;
      
      const toDel = doses.filter(d => (t && d.type === 'tirz') || (r && d.type === 'reta') || (s && d.type === 'sema'));
      
      if(toDel.length === 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      if(confirm(`ì´ ${toDel.length}ê°œ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.`)) {
          for(const d of toDel) await deleteDoc(doc(db, "doses", d.id));
          closeResetModal();
      }
  };

  window.setViewMode = (m) => {
      viewMode = m;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)).classList.add('active');
      updateManager();
  };

  window.switchPage = (page, el) => {
      document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
      document.getElementById('section-' + page).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      if(page === 'manager' && myChart) setTimeout(()=>myChart.resize(), 10);
      if(page === 'weight' && weightChart) setTimeout(()=>weightChart.resize(), 10);
  };

  // [4] ê³„ì‚° ë° ë Œë”ë§
  function calcLevel(type) {
      const now = Date.now();
      const half = PK[type][0];
      
      let total = 0;
      const history = doses.filter(d => d.type === type).sort((a,b)=>a.time-b.time);
      
      // ìˆ˜ë™ì„¤ì • ì°¾ê¸°
      let lastManualIdx = -1;
      history.forEach((h, i) => { if(h.manual && h.time <= now) lastManualIdx = i; });
      
      if(lastManualIdx > -1) {
          const m = history[lastManualIdx];
          total = m.amt * Math.pow(0.5, (now - m.time) / 86400000 / half);
      }
      
      for(let i = lastManualIdx + 1; i < history.length; i++) {
          const d = history[i];
          if(d.time > now) break;
          if(!d.manual) {
              const days = (now - d.time) / 86400000;
              total += d.amt * Math.pow(0.5, days/half); // ë‹¨ìˆœ ë°˜ê°ê¸° ê³„ì‚°
          }
      }
      return total;
  }

  function updateManager() {
      // 1. í˜„ì¬ ë†ë„ í‘œì‹œ
      document.getElementById('valTirz').innerText = calcLevel('tirz').toFixed(2);
      document.getElementById('valReta').innerText = calcLevel('reta').toFixed(2);
      document.getElementById('valSema').innerText = calcLevel('sema').toFixed(2);

      // 2. ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
      const el = document.getElementById('historyList'); el.innerHTML = '';
      const filtered = doses.filter(d => viewMode === 'all' || d.type === viewMode).sort((a,b)=>b.time-a.time);
      
      filtered.forEach(d => {
          const dt = new Date(d.time);
          const dateStr = `${dt.getMonth()+1}.${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,'0')}`;
          el.innerHTML += `
            <div class="list-item">
                <div><span class="tag ${d.type}">${d.type}</span> <b>${d.amt}mg</b> <span style="color:#888; font-size:0.8em">(${dateStr})</span> ${d.manual?'<span style="color:red;font-size:0.7em">[ìˆ˜ë™]</span>':''}</div>
                <button class="del-btn" onclick="delDose('${d.id}')">âœ•</button>
            </div>`;
      });

      // 3. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
      drawChart();
  }

  function updateWeight() {
      const el = document.getElementById('weightList'); el.innerHTML = '';
      const sorted = weightData.sort((a,b)=>b.time-a.time);
      if(sorted.length) document.getElementById('valCurWeight').innerText = sorted[0].weight;

      sorted.forEach(d => {
          const dt = new Date(d.time);
          el.innerHTML += `
            <div class="list-item">
                <div><span class="tag weight">ì²´ì¤‘</span> <b>${d.weight}kg</b> <span style="color:#888">(${dt.getMonth()+1}.${dt.getDate()})</span></div>
                <button class="del-btn" onclick="delWeight('${d.id}')">âœ•</button>
            </div>`;
      });
      drawWeightChart();
  }

  function drawChart() {
      const ctx = document.getElementById('myChart').getContext('2d');
      if(myChart) myChart.destroy();
      
      const labels = [], d1=[], d2=[], d3=[];
      const start = Date.now() - 5*86400000;
      for(let i=0; i<20; i++) {
          const t = start + i*86400000;
          labels.push(new Date(t).getDate());
          d1.push(calcSim(t, 'tirz'));
          d2.push(calcSim(t, 'reta'));
          d3.push(calcSim(t, 'sema'));
      }
      
      myChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
              { label:'T', data:d1, borderColor:'#36a2eb', borderWidth:2, pointRadius:1 },
              { label:'R', data:d2, borderColor:'#ff6384', borderWidth:2, pointRadius:1 },
              { label:'S', data:d3, borderColor:'#28a745', borderWidth:2, pointRadius:1 }
          ]},
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
  }

  function drawWeightChart() {
      const ctx = document.getElementById('weightChart').getContext('2d');
      if(weightChart) weightChart.destroy();
      
      const data = weightData.sort((a,b)=>a.time-b.time);
      weightChart = new Chart(ctx, {
          type: 'line',
          data: { 
              labels: data.map(d=>new Date(d.time).getDate()), 
              datasets: [{ data: data.map(d=>d.weight), borderColor:'#6610f2', fill:true, backgroundColor:'rgba(102,16,242,0.1)' }]
          },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
  }

  function calcSim(time, type) {
      let sum = 0;
      const h = PK[type][0];
      const targets = doses.filter(d=>d.type===type && d.time <= time);
      let lastMan = -1;
      targets.forEach((d,i)=>{ if(d.manual) lastMan=i; });
      
      if(lastMan > -1) {
          sum = targets[lastMan].amt * Math.pow(0.5, (time-targets[lastMan].time)/86400000/h);
      }
      for(let i=lastMan+1; i<targets.length; i++) {
          sum += targets[i].amt * Math.pow(0.5, (time-targets[i].time)/86400000/h);
      }
      return sum;
  }

</script>
</body>
</html>